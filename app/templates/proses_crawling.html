<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proses Crawling - {{ project_name }}</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --dark-bg: #212529;
            --light-bg: #2c3034; 
            --text-light: #f8f9fa;
            --text-muted-light: #adb5bd;
            --border-color: #495057;
            --danger-text: #f85149; 
            --success-text: #28a745; 
            --info-text: #17a2b8; 
            --update-text: #ffc107; 
        }
        body {
            background-color: var(--dark-bg);
            color: var(--text-light);
            font-family: 'Open Sans', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }
        .crawl-status-container {
            background-color: var(--light-bg);
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.25);
            width: 100%;
            max-width: 900px; /* Lebarkan agar log muat */
            text-align: center;
        }
        .crawl-status-container h3 {
            font-family: 'Montserrat', sans-serif;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .crawl-status-container .lead {
            color: var(--text-muted-light);
            margin-bottom: 1.5rem;
        }
        .crawl-log-box {
            background-color: var(--dark-bg); /* Latar belakang log box */
            border: 1px solid var(--border-color);
            border-radius: 0.3rem;
            padding: 1.5rem;
            max-height: 400px; /* Tinggi maksimal log box */
            overflow-y: auto; /* Scroll jika log panjang */
            text-align: left; /* Ratakan teks log ke kiri */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #c8c8c8; /* Warna teks log default */
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .crawl-log-box p { margin-bottom: 0.3rem; white-space: pre-wrap; word-break: break-all; }
        .log-error { color: var(--danger-text); font-weight: bold; } 
        .log-success { color: var(--success-text); } 
        .log-info { color: var(--info-text); } 
        .log-update { color: var(--update-text); }
        
        .redirect-message {
            margin-top: 1.5rem;
            color: var(--text-muted-light);
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="crawl-status-container">
        <div class="spinner-border" role="status" id="initialSpinner">
            <span class="sr-only">Loading...</span>
        </div>
        <h3><span id="statusTitle">Memulai Proses Crawling</span></h3>
        <p class="lead" id="statusMessage">
            Sedang melakukan crawling untuk <strong>{{ current_institution_name }}</strong> dengan kata kunci "<strong>{{ keyword }}</strong>".<br>
            Proses ini bisa memakan waktu beberapa saat hingga beberapa menit tergantung target dan kedalaman. Mohon bersabar.
        </p>
        
        <div id="logOutput" class="crawl-log-box" style="display: none;"> <h5 style="color: var(--text-light); font-family: 'Montserrat', sans-serif; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem;">Log Proses Crawling:</h5>
            {% if crawl_log %}
                {% for log_entry in crawl_log %}
                    {% set log_class = '' %}
                    {% if 'Error' in log_entry or 'GAGAL' in log_entry or 'Forbidden' in log_entry or 'Timeout' in log_entry %}
                        {% set log_class = 'log-error' %}
                    {% elif 'SUKSES:' in log_entry %}
                        {% set log_class = 'log-success' %}
                    {% elif 'UPDATE:' in log_entry %}
                        {% set log_class = 'log-update' %}
                    {% elif 'Seed URL' in log_entry or 'Memulai crawling' in log_entry or 'Crawling untuk institusi' in log_entry and 'selesai' in log_entry %}
                         {% set log_class = 'log-info' %}
                    {% endif %}
                    <p class="{{ log_class }}">{{ log_entry }}</p>
                {% endfor %}
            {% else %}
                <p>Tidak ada detail log untuk ditampilkan.</p>
            {% endif %}
        </div>

        <div id="crawlSummary" class="alert alert-secondary mt-3" style="display: none; background-color: var(--light-bg); border-color: var(--border-color); color: var(--text-light);">
             </div>

        <p class="redirect-message" id="redirectMessage" style="display: none;">
            Anda akan diarahkan ke halaman hasil pencarian dalam <span id="countdown">5</span> detik...
            Atau <a href="{{ redirect_url }}" style="color: var(--primary-color); text-decoration: underline;">klik di sini jika tidak diarahkan</a>.
        </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var logOutputDiv = document.getElementById('logOutput');
            var crawlSummaryDiv = document.getElementById('crawlSummary');
            var redirectMessageDiv = document.getElementById('redirectMessage');
            var statusTitle = document.getElementById('statusTitle');
            var statusMessage = document.getElementById('statusMessage');
            var initialSpinner = document.getElementById('initialSpinner');
            
            var crawlSummaryText = {{ crawl_summary|tojson|safe }}; 
            var hasCrawlLog = {{ (crawl_log|length > 0)|tojson }}; // PERBAIKAN di sini

            if (logOutputDiv && hasCrawlLog) { // Menggunakan variabel boolean JS
                logOutputDiv.style.display = 'block';
            }
            if (crawlSummaryDiv && crawlSummaryText) { 
                crawlSummaryDiv.innerHTML = '<strong>Ringkasan:</strong> ' + crawlSummaryText; 
                crawlSummaryDiv.style.display = 'block';
            }

            statusTitle.textContent = "Proses Crawling Selesai";
            statusMessage.innerHTML = "Log proses crawling ditampilkan di bawah. Anda akan segera diarahkan ke hasil pencarian.";
            if(initialSpinner) initialSpinner.style.display = 'none';

            redirectMessageDiv.style.display = 'block';
            var countdownElement = document.getElementById('countdown');
            var seconds = 5; 
            
            var countdownInterval = setInterval(function() {
                seconds--;
                countdownElement.textContent = seconds;
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = "{{ redirect_url }}"; // Pastikan redirect_url di-quote dengan benar
                }
            }, 1000);
        });
    </script>
</body>
</html>
